<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="stylesheet" type="text/css" href="https://decipheringbigdata.com/theme/css/style.css">
	<!--<link rel="stylesheet/less" type="text/css" href="/theme/css/style.less">-->
	<!--<script src="/theme/js/less.js" type="text/javascript"></script>-->
	<link rel="stylesheet" type="text/css" href="https://decipheringbigdata.com/theme/css/pygments.css">
	<link href='//fonts.googleapis.com/css?family=Open+Sans:800,400,300|Inconsolata' rel='stylesheet' type='text/css'>



		<title>Deciphering Big Data</title>
		<meta charset="utf-8" />
</head>
<body>
	<section id="sidebar">
		<figure id="user_logo">
            <a href="https://decipheringbigdata.com"><div class="logo">&nbsp;</div></a>
		</figure>

		<div class="user_meta">
            <h1 id="user"><a href="https://decipheringbigdata.com" class="">Adams Rosales</a></h1>
			<h2></h2>
			<p class="bio">has some opinions about data engineering</p>
			<ul>
					<a href="https://decipheringbigdata.com/pages/about-me.html">About Me</a><br><br>
					<a href="https://www.linkedin.com/in/adamsr09/">LinkedIn</a>
			</ul>
		</div>
		<footer>
			<address>
				Powered by <a href="https://blog.getpelican.com/">Pelican</a>
			</address>
		</footer>
	</section>

	<section id="posts">
	<header>
		<h1>Adams Rosales's blog</h1>
		<h3>Posted Dec 17, 2020</h3>
	</header>
	<article>
		<h1 id="title">
			<a href="https://decipheringbigdata.com/my-friend-sam.html" rel="bookmark"
				title="Permalink to My Friend, Sam">My Friend, Sam</a>
		</h1>
		<div class="section" id="noserver">
<h2>NoServer</h2>
<p>Your own servers...</p>
<p>You don't need them!</p>
<img alt="Ron throws a computer away" src="https://media.giphy.com/media/HteV6g0QTNxp6/giphy.gif" style="width: 50%;" />
<p>Instead, you can use a cloud providers' servers to run code when you want. Scale up or down as you wish and pay only for
what you use.</p>
<p>One of the services that allows you to do that is AWS Lambda. Let's jump in!</p>
</div>
<div class="section" id="setting-up">
<h2>Setting Up</h2>
<p>You will need:</p>
<ol class="arabic simple">
<li>An AWS account - <a class="reference external" href="https://tinyurl.com/y92rahe9">https://tinyurl.com/y92rahe9</a></li>
<li>The AWS CLI - <a class="reference external" href="https://tinyurl.com/y3exq8mg">https://tinyurl.com/y3exq8mg</a></li>
<li>An admin IAM user - <a class="reference external" href="https://tinyurl.com/yybtpoy6">https://tinyurl.com/yybtpoy6</a></li>
<li>SAM CLI - <a class="reference external" href="https://tinyurl.com/yepgnqtg">https://tinyurl.com/yepgnqtg</a></li>
<li>The AWS CLI configured to use the admin IAM user - <a class="reference external" href="https://tinyurl.com/y6wp8vqo">https://tinyurl.com/y6wp8vqo</a></li>
<li>A Twitter developer account - <a class="reference external" href="https://tinyurl.com/yd9u8d5a">https://tinyurl.com/yd9u8d5a</a></li>
</ol>
</div>
<div class="section" id="creating-a-lambda-application">
<h2>Creating a Lambda Application</h2>
<p>One of the ways to start building with Lambda is by using the AWS Serverless Application Model (SAM). This is
just a framework that allows developers to easily create, configure, and deploy serverless applications on AWS. We can
get started doing just that with the SAM CLI I linked to above.</p>
<p>Start with a sample SAM template by running the following.</p>
<div class="highlight"><pre><span></span>$ sam init
</pre></div>
<p>This will prompt you for a few things. Choose the options below:</p>
<ol class="arabic simple">
<li>Which template source would you like to use? -&gt; AWS Quick Start Templates</li>
<li>What package type would you like to use? -&gt; Zip</li>
<li>Which runtime would you like to use? -&gt; python3.7</li>
<li>Project name: -&gt; SampleApp</li>
<li>AWS quick start application templates: -&gt; Hello World Example</li>
</ol>
<p>The app you create should have the following structure.</p>
<img alt="A sample Lambda application structure" src="/static/post7/post7_lambda_tree.jpg" style="width: 60%;" />
<p>The Python package with the main application code is under hello_world. This is unit tested with the tests defined in
the tests directory. The events directory just contains JSON event payloads for testing. Finally, the template.yml file
has the CloudFormation template which defines the actual Lambda function to deploy and any other resource you want to
create along with the Lambda when deploying to AWS.</p>
<p>Deploying is a breeze. Just run the following:</p>
<div class="highlight"><pre><span></span>$ sam build <span class="o">&amp;&amp;</span> sam deploy --guided
</pre></div>
<p>If you go to the CloudFormation console on AWS, you should see the app being deployed along with SAM related resources.</p>
<img alt="Lambda deployment to CFN with SAM" src="/static/post7/post7_sam_deployment.jpg" style="width: 100%;" />
</div>
<div class="section" id="making-the-lambda-semi-useful">
<h2>Making the Lambda (Semi) Useful</h2>
<p>Next we'll use this sample Lambda function that has already been deployed as a base for the Lambda we'll actually
write and deploy. We just need to write the code and add some additional resources like an EventBridge scheduler
and IAM roles to access other AWS services.</p>
<p>Now it's almost Christmas and so far I have missed out on gifting myself a PlayStation 5 because it has pretty much been
out of stock everywhere. Any time I hear about restocks it's always too late. However, I did notice the other day while I
was perusing Twitter that there are quite a few accounts that Tweet out when PS5s have been restocked online. Most of them
are garbage but there are a few golden leads.</p>
<p>One of them is a site called Newegg. They Tweet out these standardized restock alerts when they receive new inventory
of some hot product. The Tweets looks like this:</p>
<img alt="Lambda deployment to CFN with SAM" src="/static/post7/post7_newegg_tweet.jpg" style="width: 100%;" />
<p>I really like that little siren character. It means I can write a listener that just looks for a combination of that
one character with the words restock and PS5/PlayStation and sends me an e-mail when there's a match. This should hopefully
filter out a lot of the false positives, especially with all the random chatter about the PS5 being out of stock
everywhere.</p>
</div>
<div class="section" id="creating-the-aws-resources">
<h2>Creating the AWS Resources</h2>
<p>To create the resources needed for this I edited the template.yaml CloudFormation template. They include:</p>
<ul class="simple">
<li>The Lambda itself (already created but I edit it for my purposes and removed default API Gateway)</li>
<li>The Lambda role with access to SNS</li>
<li>The EventBridge scheduler running every 15 minutes</li>
<li>The permission for the EventBridge scheduler to invoke the Lambda</li>
</ul>
<p>This template is below.</p>
<div class="highlight"><pre><span></span><span class="nt">AWSTemplateFormatVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2010-09-09&#39;</span><span class="w"></span>
<span class="nt">Transform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless-2016-10-31</span><span class="w"></span>
<span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Restock Notification App</span><span class="w"></span>

<span class="nt">Resources</span><span class="p">:</span><span class="w"></span>

<span class="w">  </span><span class="c1"># SNS to send restock text messages to your e-mail</span><span class="w"></span>
<span class="w">  </span><span class="nt">RestockSns</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::SNS::Topic</span><span class="w"></span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">Subscription</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Endpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;[EMAIL</span><span class="nv"> </span><span class="s">HERE]&quot;</span><span class="w"></span>
<span class="w">          </span><span class="nt">Protocol</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;email&quot;</span><span class="w"></span>
<span class="w">      </span><span class="nt">TopicName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;RestockSns&quot;</span><span class="w"></span>

<span class="w">  </span><span class="c1"># The Lambda function to deploy</span><span class="w"></span>
<span class="w">  </span><span class="nt">RestockListener</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span><span class="w"></span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restock_listener/</span><span class="w"></span>
<span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app.lambda_handler</span><span class="w"></span>
<span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.7</span><span class="w"></span>
<span class="w">      </span><span class="nt">Role</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LambdaRole.Arn</span><span class="w"></span>
<span class="w">      </span><span class="nt">Timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">600</span><span class="w"></span>
<span class="w">      </span><span class="nt">MemorySize</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">256</span><span class="w"></span>
<span class="w">      </span><span class="nt">Environment</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">Variables</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">sns_topic_arn</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RestockSns</span><span class="w"></span>

<span class="w">  </span><span class="c1"># The role to attach to the Lambda that allows it to use other AWS services</span><span class="w"></span>
<span class="w">  </span><span class="nt">LambdaRole</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::IAM::Role</span><span class="w"></span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">Statement</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;sts:AssumeRole&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">            </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span><span class="w"></span>
<span class="w">            </span><span class="nt">Principal</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="nt">Service</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">lambda.amazonaws.com</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">Policies</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">PolicyDocument</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">Statement</span><span class="p">:</span><span class="w"></span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;sns:*&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">                </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span><span class="w"></span>
<span class="w">                </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span><span class="w"></span>
<span class="w">            </span><span class="nt">Version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2012-10-17&#39;</span><span class="w"></span>
<span class="w">          </span><span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LambdaRole</span><span class="w"></span>

<span class="w">  </span><span class="c1"># Runs the RestockListener Lambda function on a schedule</span><span class="w"></span>
<span class="w">  </span><span class="nt">RestockListenerSchedule</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Events::Rule</span><span class="w"></span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ScheduledRule&quot;</span><span class="w"></span>
<span class="w">      </span><span class="nt">ScheduleExpression</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rate(15</span><span class="nv"> </span><span class="s">minutes)&quot;</span><span class="w"></span>
<span class="w">      </span><span class="nt">State</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ENABLED&quot;</span><span class="w"></span>
<span class="w">      </span><span class="nt">Targets</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Arn</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RestockListener.Arn</span><span class="w"></span>
<span class="w">          </span><span class="nt">Id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;RestockListenerV1&quot;</span><span class="w"></span>

<span class="w">  </span><span class="c1"># Provides scheduler access to the Lambda</span><span class="w"></span>
<span class="w">  </span><span class="nt">PermissionForEventsToInvokeRestockListener</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Lambda::Permission</span><span class="w"></span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">FunctionName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RestockListener</span><span class="w"></span>
<span class="w">      </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;lambda:InvokeFunction&quot;</span><span class="w"></span>
<span class="w">      </span><span class="nt">Principal</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;events.amazonaws.com&quot;</span><span class="w"></span>
<span class="w">      </span><span class="nt">SourceArn</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RestockListenerSchedule.Arn</span><span class="w"></span>

<span class="nt">Outputs</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">RestockListener</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Restock</span><span class="nv"> </span><span class="s">Listener</span><span class="nv"> </span><span class="s">Lambda</span><span class="nv"> </span><span class="s">function&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RestockListener.Arn</span><span class="w"></span>
<span class="w">  </span><span class="nt">LambdaRole</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Restock</span><span class="nv"> </span><span class="s">Listener</span><span class="nv"> </span><span class="s">Lambda</span><span class="nv"> </span><span class="s">role&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LambdaRole.Arn</span><span class="w"></span>
</pre></div>
<p>The [EMAIL HERE] in the SNS endpoint should be filled out with the e-mail address that the Lambda will send the
notifications to.</p>
</div>
<div class="section" id="implementing-the-notification-component">
<h2>Implementing the Notification Component</h2>
<p>In order for the Lambda to send a notification to the SNS that was deployed with it, it needs to be able to access it
and call the SNS API endpoint with a message to send. The Lambda should already have access to SNS through the role
that is also included in the SAM/CloudFormation template but sending the actual message still needs to be implemented.</p>
<p>Since this is a Python Lambda, we can use AWS' Python SDK - <a class="reference external" href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">boto3</a>.
Below I implement a set of simple utility functions to send a message to an SNS endpoint using the boto3 SDK.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">boto3</span>


<span class="k">def</span> <span class="nf">_get_aws_client</span><span class="p">(</span><span class="n">service</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Retrieves a boto3 client for the given service name if one is not already provided&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">client</span>


<span class="k">def</span> <span class="nf">_get_sns_client</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Retrieves an SNS boto3 client&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_aws_client</span><span class="p">(</span><span class="s2">&quot;sns&quot;</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_send_message</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">topic_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Sends a given message to an SNS topic ARN with the provided SNS client</span>

<span class="sd">    :returns the response received back from the request</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
        <span class="n">TopicArn</span><span class="o">=</span><span class="n">topic_arn</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
        <span class="n">Subject</span><span class="o">=</span><span class="n">subject</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>The first two functions retrieve an SNS boto3 client which we can use to access the different SNS API endpoints. To
publish a message we just need to call the <a class="reference external" href="https://tinyurl.com/y72u9cbh">publish</a>  method of this client object.</p>
</div>
<div class="section" id="implementing-the-tweet-retriever">
<h2>Implementing the Tweet Retriever</h2>
<p>Now I implement the logic to get a user's tweets and filter to just the ones that contain a list of search terms
and special unicode characters (to find the little Newegg siren). I'm keeping this as simple as possible by using just
the default Tweepy user_timeline functionality, which retrieves the last 20 tweets. This may not work when a user
tweets more often than that in between Lambda invocations but that's okay because I'm running the Lambda on a schedule
every 15 minutes and Newegg only tweets out a few times a day.</p>
<p>Also one of the drawbacks of the serverless approach is that individual Lambda functions cannot keep state in between
executions without using external data stores or more complex step functions state machines. This means that as is,
the Lambda won't be able to dedupe tweets that it has already received. If there's a matching tweet from Newegg, it will
send me the same alert over and over as long as it's part of the last 20 tweets. However, in this scenario, this is
actually a good thing because I really want that PS5. I want to make sure I receive the alert multiple times if I happen
to miss it the first time around. Alternatively, we can always put a filter on the tweet logic to limit the result set
to just the tweets in the X minutes prior to the time of invocation.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_authorized_tweepy_client</span><span class="p">(</span>
    <span class="n">consumer_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">consumer_secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">access_token_secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tweepy</span><span class="o">.</span><span class="n">API</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Retrieves an authorized Tweepy API client to use when extracting Tweets</span>

<span class="sd">    :param consumer_key</span>
<span class="sd">    :param consumer_secret</span>
<span class="sd">    :param access_token</span>
<span class="sd">    :param access_token_secret</span>
<span class="sd">    :returns a signed Tweepy client</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">tweepy</span><span class="o">.</span><span class="n">OAuthHandler</span><span class="p">(</span><span class="n">consumer_key</span><span class="p">,</span> <span class="n">consumer_secret</span><span class="p">)</span>
    <span class="n">auth</span><span class="o">.</span><span class="n">set_access_token</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">access_token_secret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tweepy</span><span class="o">.</span><span class="n">API</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_matching_tweets</span><span class="p">(</span><span class="n">screen_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">search_terms</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">special_unicode</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">tweepy</span><span class="o">.</span><span class="n">API</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the last 20 Tweets in the given user&#39;s timeline and filters them to those containing the given terms</span>
<span class="sd">    and unicode characters</span>

<span class="sd">    :param screen_name - the Twitter user handle to search for</span>
<span class="sd">    :param search_terms - a list of terms to filter Tweets by (must contain all terms in the list)</span>
<span class="sd">    :param special_unicode - a list of unicode values (equivalent of ord(char)) for any special characters (emojis)</span>
<span class="sd">    :param client - the Tweepy client to use for the request to retrieve Tweets</span>
<span class="sd">    :returns a list of matching Tweets containing the required terms and special characters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the last 20 tweets in the user&#39;s timeline</span>
    <span class="n">user_tweets</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">user_timeline</span><span class="p">(</span><span class="n">screen_name</span><span class="o">=</span><span class="n">screen_name</span><span class="p">)</span>
    <span class="n">matching_tweets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Find matching tweets in the user&#39;s timeline</span>
    <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">user_tweets</span><span class="p">:</span>
        <span class="n">tweet_text</span> <span class="o">=</span> <span class="n">tweet</span><span class="o">.</span><span class="n">text</span>
        <span class="c1"># Retrieve individual unicode characters in the tweet text to check for any special characters</span>
        <span class="n">unicode_chars_in_tweet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">ord</span><span class="p">(</span><span class="n">character</span><span class="p">)</span> <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">tweet_text</span><span class="p">])</span>
        <span class="n">matching</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># If any of the search terms are not in the tweet, skip it</span>
        <span class="k">for</span> <span class="n">search_term</span> <span class="ow">in</span> <span class="n">search_terms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">search_term</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tweet_text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">matching</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="c1"># If any of the special unicode characters are missing from the tweet, also skip it</span>
        <span class="k">for</span> <span class="n">special_unicode_char</span> <span class="ow">in</span> <span class="n">special_unicode</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">special_unicode_char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unicode_chars_in_tweet</span><span class="p">:</span>
                <span class="n">matching</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="c1"># If all of the required search terms and special unicode characters are in the tweet, keep track of it</span>
        <span class="k">if</span> <span class="n">matching</span><span class="p">:</span>
            <span class="n">matching_tweets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tweet_text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matching_tweets</span>
</pre></div>
<p>All this is doing is retrieving the last 20 tweets and retuning just those that contain all of the search terms we
require and any special characters provided. More information about the Tweepy API can be found <a class="reference external" href="http://docs.tweepy.org/en/latest/">here</a>.</p>
</div>
<div class="section" id="implementing-the-lambda-handler">
<h2>Implementing the Lambda Handler</h2>
<p>To finish up, all we need to do is implement the handler itself. This is the function exposed through Lambda and what
will be called by EventBridge every 15 minutes.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_verify_event_payload</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Raises exception if the Lambda input is invalid</span>

<span class="sd">    :param event - a dictionary containing the key/value pairs passed in as an event payload to the Lambda</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_inputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="s2">&quot;consumer_key&quot;</span><span class="p">,</span> <span class="s2">&quot;consumer_secret&quot;</span><span class="p">,</span> <span class="s2">&quot;access_token&quot;</span><span class="p">,</span>
        <span class="s2">&quot;access_token_secret&quot;</span><span class="p">,</span> <span class="s2">&quot;screen_name&quot;</span><span class="p">,</span> <span class="s2">&quot;search_terms&quot;</span><span class="p">,</span> <span class="s2">&quot;special_unicode&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">required_input</span> <span class="ow">in</span> <span class="n">required_inputs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">required_input</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The provided event payload is missing required input - </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_input</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;search_terms&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;special_unicode&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; The main handler function that will run as a Lambda</span>

<span class="sd">    :param event - a dictionary of key/value data to operate with</span>
<span class="sd">    :returns a response from the SNS service when the Lambda sends out a notification, otherwise an empty dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get event input provided to Lambda and verify it (exception will be thrown at this point if anything is off)</span>
    <span class="n">_verify_event_payload</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="c1"># Retrieve matching tweets for the given user</span>
    <span class="n">tweepy_client</span> <span class="o">=</span> <span class="n">_get_authorized_tweepy_client</span><span class="p">(</span>
        <span class="n">event</span><span class="p">[</span><span class="s2">&quot;consumer_key&quot;</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;consumer_secret&quot;</span><span class="p">],</span>
        <span class="n">event</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;access_token_secret&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">matching_tweets</span> <span class="o">=</span> <span class="n">_get_matching_tweets</span><span class="p">(</span>
        <span class="n">event</span><span class="p">[</span><span class="s2">&quot;screen_name&quot;</span><span class="p">],</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;search_terms&quot;</span><span class="p">],</span>
        <span class="n">event</span><span class="p">[</span><span class="s2">&quot;special_unicode&quot;</span><span class="p">],</span> <span class="n">tweepy_client</span>
    <span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matching_tweets</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Send a message if there are any matching tweets</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_tweets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Get the SNS topic ARN to send an alert message to from Lambda&#39;s environment variables</span>
        <span class="n">sns_topic_arn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;sns_topic_arn&quot;</span><span class="p">]</span>
        <span class="c1"># Retrieve the SNS client</span>
        <span class="n">sns_client</span> <span class="o">=</span> <span class="n">_get_sns_client</span><span class="p">()</span>
        <span class="c1"># Send the message</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">_send_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">],</span> <span class="n">sns_topic_arn</span><span class="p">,</span> <span class="n">sns_client</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>The Lambda will receive an event payload from EventBridge containing all of the necessary inputs to run the alarming
with. Those include the subject of the alarm (e-mail subject when sending to the user), the Twitter developer keys and
tokens (bad practice - don't do this!), the Twitter screen name to retrieve tweets for, and the search terms/special
unicode characters to filter by.</p>
<p>Here I'm providing the Twitter keys as an input because I'm sure no one else is using this and it's a toy example.
In practice you would want to store these keys in a secure location that your Lambda can access. AWS offers a service
for this called <a class="reference external" href="https://aws.amazon.com/secrets-manager/">SecretsManager</a>.</p>
<p>Anyway, to include this payload in the EventBridge scheduler we can just add it to the CloudFormation template like so:</p>
<div class="highlight"><pre><span></span><span class="c1"># Runs the RestockListener Lambda function on a schedule</span><span class="w"></span>
<span class="nt">RestockListenerSchedule</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Events::Rule</span><span class="w"></span>
<span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ScheduledRule&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">ScheduleExpression</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rate(15</span><span class="nv"> </span><span class="s">minutes)&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">State</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ENABLED&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">Targets</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Arn</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RestockListener.Arn</span><span class="w"></span>
<span class="w">        </span><span class="nt">Id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;RestockListenerV1&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">Input</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;subject&quot;:</span><span class="nv"> </span><span class="s">&quot;RESTOCK</span><span class="nv"> </span><span class="s">ALERT!&quot;,</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;consumer_key&quot;:</span><span class="nv"> </span><span class="s">&quot;&quot;,</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;consumer_secret&quot;:</span><span class="nv"> </span><span class="s">&quot;&quot;,</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;access_token&quot;:</span><span class="nv"> </span><span class="s">&quot;&quot;,</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;access_token_secret&quot;:</span><span class="nv"> </span><span class="s">&quot;&quot;,</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;screen_name&quot;:</span><span class="nv"> </span><span class="s">&quot;Newegg&quot;,</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;search_terms&quot;:</span><span class="nv"> </span><span class="s">[</span><span class="w"></span>
<span class="w">              </span><span class="s">&quot;restock&quot;,</span><span class="nv"> </span><span class="s">&quot;ps5&quot;</span><span class="w"></span>
<span class="w">          </span><span class="s">],</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;special_unicode&quot;:</span><span class="nv"> </span><span class="s">[</span><span class="w"></span>
<span class="w">              </span><span class="s">128680</span><span class="w"></span>
<span class="w">          </span><span class="s">]</span><span class="w"></span>
<span class="w">        </span><span class="s">}&#39;</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="deploying-and-testing">
<h2>Deploying and Testing</h2>
<p>To deploy I run:</p>
<div class="highlight"><pre><span></span>$ sam build <span class="o">&amp;&amp;</span> sam deploy
</pre></div>
<p>With a bit of luck everything works and I'll have a PS5 in no time.</p>
<p>To test this at runtime I can configure a test event in the AWS console. Since I'm sure Newegg has tweeted some restock
alerts recently I will run the Lambda with the following payload (just including &quot;restock&quot; as a term without the
additional &quot;ps5&quot; requirement).</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;RESTOCK ALERT!&quot;</span><span class="p">,</span>
    <span class="s2">&quot;consumer_key&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;consumer_secret&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;access_token_secret&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;screen_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Newegg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;search_terms&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;restock&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;special_unicode&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="mi">128680</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
<img alt="A Lambda restock alarm test configuration" src="/static/post7/post7_lambda_test_configuration.jpg" style="width: 100%;" />
<p>Hit Test and voila!</p>
<img alt="An e-mail from the restock Lambda service" src="/static/post7/post7_restock_email.jpg" style="width: 100%;" />
<p>You can see the full code in my <a class="reference external" href="https://github.com/adaros92/RestockLambda">GitHub repo</a>.</p>
</div>


		<div id="article_meta">
				Category:
					<a href="https://decipheringbigdata.com/category/aws.html">AWS</a>
				<br />Tags:
					<a href="https://decipheringbigdata.com/tag/aws.html">AWS</a>
		</div>
	</article>

	<footer>
		<a href="https://decipheringbigdata.com/" class="button_accent">&larr;&nbsp;&nbsp;&nbsp;Back to blog</a>
	</footer>


	</section>

</body>
</html>