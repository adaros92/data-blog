<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="stylesheet" type="text/css" href="https://decipheringbigdata.com/theme/css/style.css">
	<!--<link rel="stylesheet/less" type="text/css" href="/theme/css/style.less">-->
	<!--<script src="/theme/js/less.js" type="text/javascript"></script>-->
	<link rel="stylesheet" type="text/css" href="https://decipheringbigdata.com/theme/css/pygments.css">
	<link href='//fonts.googleapis.com/css?family=Open+Sans:800,400,300|Inconsolata' rel='stylesheet' type='text/css'>



		<title>Deciphering Big Data</title>
		<meta charset="utf-8" />
</head>
<body>
	<section id="sidebar">
		<figure id="user_logo">
            <a href="https://decipheringbigdata.com"><div class="logo">&nbsp;</div></a>
		</figure>

		<div class="user_meta">
            <h1 id="user"><a href="https://decipheringbigdata.com" class="">Adams Rosales</a></h1>
			<h2></h2>
			<p class="bio">has some opinions about data engineering</p>
			<ul>
			</ul>
		</div>
		<footer>
			<address>
				Powered by <a href="http://pelican.notmyidea.org/">Pelican</a>,
		                theme by <a href="https://github.com/wting/pelican-svbtle">wting</a>.
			</address>
		</footer>
	</section>

	<section id="posts">
	<header>
		<h1>Adams Rosales's blog</h1>
		<h3>Posted Mar 27, 2021</h3>
	</header>
	<article>
		<h1 id="title">
			<a href="https://decipheringbigdata.com/scala-spark-hello-world.html" rel="bookmark"
				title="Permalink to Scala Spark Hello World">Scala Spark Hello World</a>
		</h1>
		<div class="section" id="motivation">
<h2>Motivation</h2>
<p>Spark is a hot skill these days! There are so many tutorials out there on it but I find that most of them miss the mark
on how you actually get started with a Spark project from scratch. Unless you've worked in a professional environment
with Spark pipelines written from scratch it's unlikely that you've been introduced to how to properly structure
a project, set up build dependencies, and write unit tests. In this post I go through a bare-bones SBT template as an
example of how to do just that.</p>
<p>I'm assuming you already have Scala, SBT, and Apache Spark installed. If not, you can follow <a class="reference external" href="https://docs.scala-lang.org/getting-started/sbt-track/getting-started-with-scala-and-sbt-on-the-command-line.html">the scala docs</a>
to install SBT and Scala and <a class="reference external" href="https://www.freecodecamp.org/news/installing-scala-and-apache-spark-on-mac-os-837ae57d283f/">this from freecodecamp</a> to
install Spark.</p>
</div>
<div class="section" id="create-sbt-project">
<h2>Create SBT Project</h2>
<p>We start by creating an empty directory, changing to it, and creating a hello world SBT project.</p>
<div class="highlight"><pre><span></span>&gt; mkdir scala-spark-hello-world
&gt; <span class="nb">cd</span> scala-spark-hello-world
&gt; sbt new scala/hello-world.g8
</pre></div>
<p>This creates the following directory structure in the scala-spark-hello-world directory.</p>
<img alt="Step 1 in creating a Spark Hello World project" src="/static/post15/post15_step1.png" style="width: 100%;" />
<p>We don't need the top level project or target directories so let's just delete them and cd into cala-spark-hello-world.</p>
<div class="highlight"><pre><span></span>&gt; rm -rf project target
&gt; <span class="nb">cd</span> cala-spark-hello-world
</pre></div>
<p>In cala-spark-hellow-world we are left with this structure.</p>
<img alt="Step 2 in creating a Spark Hello World project" src="/static/post15/post15_step2.png" style="width: 100%;" />
</div>
<div class="section" id="add-dependencies">
<h2>Add Dependencies</h2>
<p>The dependencies are specified in the build.sbt file. Spark needs to be listed as a dependency along with a compatible
Scala version to use according to the Spark version you choose. Here I'm using Spark 3.0.1, which requires Scala 2.12.
I'm also adding some additional dependencies like Scalactic and ScalaTest for unit testing and scopt for command line
parsing. We can also specify the assembly merge strategy for handling deduplication when building an uber/fat jar with
all of our dependencies.</p>
<p>We can go ahead and delete the existing build.sbt file and replace it with the code snippet below.</p>
<div class="highlight"><pre><span></span><span class="n">scalaVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;2.12.1&quot;</span><span class="w"></span>

<span class="n">name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;spark-hello-world&quot;</span><span class="w"></span>
<span class="n">organization</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;ch.epfl.scala&quot;</span><span class="w"></span>
<span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span><span class="w"></span>

<span class="n">libraryDependencies</span><span class="w"> </span><span class="o">++=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;org.apache.spark&quot;</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="s">&quot;spark-core&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.0.1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;org.apache.spark&quot;</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="s">&quot;spark-sql&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.0.1&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;com.github.scopt&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;scopt_native0.2_2.11&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.6.0&quot;</span><span class="w"></span>
<span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;org.scalactic&quot;</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="s">&quot;scalactic&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.2.5&quot;</span><span class="w"></span>
<span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;org.scalatest&quot;</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="s">&quot;scalatest&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;3.2.5&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="w"></span>

<span class="n">assemblyMergeStrategy</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">assembly</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;reference.conf&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">MergeStrategy</span><span class="p">.</span><span class="n">concat</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;application.conf&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">MergeStrategy</span><span class="p">.</span><span class="n">concat</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nc">PathList</span><span class="p">(</span><span class="s">&quot;META-INF&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">_*</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">MergeStrategy</span><span class="p">.</span><span class="n">discard</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">MergeStrategy</span><span class="p">.</span><span class="n">first</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Next we have to add the <a class="reference external" href="https://github.com/sbt/sbt-assembly">assembly plugin</a> within the project directory in a
plugins.sbt file.</p>
<div class="highlight"><pre><span></span>&gt; <span class="nb">cd</span> project
&gt; touch plugins.sbt
</pre></div>
<p>Here is the one line to add to this plugins.sbt file.</p>
<div class="highlight"><pre><span></span><span class="n">addSbtPlugin</span><span class="p">(</span><span class="s">&quot;com.eed3si9n&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;sbt-assembly&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;0.15.0&quot;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="edit-src-packages">
<h2>Edit src Packages</h2>
<p>Now we're ready to start implementing the Spark logic. To do so let's reorganize the existing project a bit by creating
packages that will contain different components of our code and associated test packages for unit testing later on.</p>
<div class="highlight"><pre><span></span>&gt; <span class="nb">cd</span> src
<span class="c1"># Create test directory</span>
&gt; mkdir <span class="nb">test</span>
<span class="c1"># Create scala directory to mirror main</span>
&gt; mkdir test/scala
<span class="c1"># Remove existing Main file that&#39;s not needed</span>
&gt; rm main/scala/Main.scala
<span class="c1"># Create common package main and test directories</span>
&gt; mkdir main/scala/common test/scala/common
<span class="c1"># Create apps package in main and test directories</span>
&gt; mkdir main/scala/apps test/scala/apps
</pre></div>
<p>After all of that, the src directory will look like this.</p>
<img alt="Step 3 in creating a Spark Hello World project" src="/static/post15/post15_step3.png" style="width: 100%;" />
<p>The common package will hold components that are common across all of the codebase and the apps package will just hold
our simple Spark applications for now. This is just a bare-bones structure that can be edited to fit your use case.</p>
</div>
<div class="section" id="add-spark-session-wrappers">
<h2>Add Spark Session Wrappers</h2>
<p>When working with Spark you'll typically interact with the Spark session and context objects. Instead of instantiating
a bunch of these in different parts of the code base, you can define a single Spark session to be used across your
code. The way to do that naturally with Scala is with a trait that can be extended by objects and classes. Let's put
this wrapper in the common package.</p>
<div class="highlight"><pre><span></span><span class="k">package</span><span class="w"> </span><span class="n">common</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="nc">SparkSession</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.{</span><span class="nc">SparkConf</span><span class="p">,</span><span class="w"> </span><span class="nc">SparkContext</span><span class="p">}</span>

<span class="k">trait</span><span class="w"> </span><span class="nc">SparkWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Set config</span>
<span class="w">  </span><span class="k">protected</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">sparkConf</span><span class="p">:</span><span class="w"> </span><span class="nc">SparkConf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">SparkConf</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">protected</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">config</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">sparkConf</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">conf</span><span class="p">:</span><span class="w"> </span><span class="nc">SparkConf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">sparkConf</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">appName</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Build the spark session and retrieve spark context</span>
<span class="w">  </span><span class="k">protected</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">builder</span><span class="p">:</span><span class="w"> </span><span class="nc">SparkSession</span><span class="p">.</span><span class="nc">Builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SparkSession</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">builder</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">appName</span><span class="p">(</span><span class="n">appName</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="bp">this</span><span class="p">.</span><span class="n">conf</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">spark</span><span class="p">:</span><span class="w"> </span><span class="nc">SparkSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">getOrCreate</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">sc</span><span class="p">:</span><span class="w"> </span><span class="nc">SparkContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">sparkContext</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="nc">SparkLocalWrapper</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SparkWrapper</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">builder</span><span class="p">:</span><span class="w"> </span><span class="nc">SparkSession</span><span class="p">.</span><span class="nc">Builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">super</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">master</span><span class="p">(</span><span class="s">&quot;local&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>The components that extend these SparkWrapper and SparkLocalWrapper traits will be able to use the single session (spark)
and context (sc) instances instead of defining their own. It also allows us to set the common configuration settings in
one place in the code base, which is generally good practice.</p>
<p>Notice also how we have two traits - SparkWrapper and SparkLocalWrapper. The former is meant to be used in cluster mode
when the application is run on something like EMR or a Hadoop cluster. The latter is used when running Spark on a local
machine like your computer. If you try to run the former on your computer you will typically run into an exception that
a host is not provided or something like that.</p>
<p>We will want to use the SparkLocalWrapper while running unit tests on our local machines. We will also want to turn off
some Spark logs and add some additional configurations so that Spark knows which local host/port to use and to only use
one partition. A good way to do this is with an additional wrapper in the test directory called SparkTestWrapper, which
extends from the SparkLocalWrapper available in main/scala/common.</p>
<div class="highlight"><pre><span></span><span class="k">package</span><span class="w"> </span><span class="n">testutils</span>

<span class="k">import</span><span class="w"> </span><span class="nn">common</span><span class="p">.</span><span class="nc">SparkLocalWrapper</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">log4j</span><span class="p">.</span><span class="nc">Level</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nc">SparkConf</span>

<span class="k">object</span><span class="w"> </span><span class="nc">SparkTestWrapper</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SparkLocalWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">log4j</span><span class="p">.</span><span class="nc">Logger</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;org.apache.spark&quot;</span><span class="p">).</span><span class="n">setLevel</span><span class="p">(</span><span class="nc">Level</span><span class="p">.</span><span class="nc">WARN</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">log4j</span><span class="p">.</span><span class="nc">Logger</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;org.apache.hadoop.input.LineRecordReader&quot;</span><span class="p">).</span><span class="n">setLevel</span><span class="p">(</span><span class="nc">Level</span><span class="p">.</span><span class="nc">ERROR</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">log4j</span><span class="p">.</span><span class="nc">Logger</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;org.apache.hadoop.mapreduce.lib.output.FileOutputCommitter&quot;</span><span class="p">).</span><span class="n">setLevel</span><span class="p">(</span><span class="nc">Level</span><span class="p">.</span><span class="nc">ERROR</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">log4j</span><span class="p">.</span><span class="nc">Logger</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;org.apache.hadoop.output.FileOutputCommitter&quot;</span><span class="p">).</span><span class="n">setLevel</span><span class="p">(</span><span class="nc">Level</span><span class="p">.</span><span class="nc">ERROR</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">log4j</span><span class="p">.</span><span class="nc">Logger</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;org.apache.hadoop.mapreduce.lib.input.LineRecordReader&quot;</span><span class="p">).</span><span class="n">setLevel</span><span class="p">(</span><span class="nc">Level</span><span class="p">.</span><span class="nc">ERROR</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">appName</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SparkTestWrapper&quot;</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">conf</span><span class="p">:</span><span class="w"> </span><span class="nc">SparkConf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="p">(</span><span class="s">&quot;spark.sql.shuffle.partitions&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="p">(</span><span class="s">&quot;spark.ui.enabled&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="p">(</span><span class="s">&quot;spark.driver.bindAddress&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="p">(</span><span class="s">&quot;spark.driver.host&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="p">(</span><span class="s">&quot;spark.sql.catalogImplementation&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;in-memory&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="p">(</span><span class="s">&quot;spark.driver.port&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8888&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">config</span><span class="p">(</span><span class="s">&quot;spark.sql.autoBroadcastJoinThreshold&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="bp">super</span><span class="p">.</span><span class="n">conf</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>I have placed this in a separate test package called testutils (test/scala/testutils). The updated file tree looks like
this.</p>
<img alt="Step 4 in creating a Spark Hello World project" src="/static/post15/post15_step4.png" style="width: 100%;" />
</div>
<div class="section" id="add-spark-applications">
<h2>Add Spark Applications</h2>
<p>To add a Spark application we can create a new entry point in the apps package. Below is just a simple application to
count the words in a given block of text. It just parses the text using the scopt library and calls the countWords method
on it to perform the word counting. Notice how it extends the SparkWrapper from the common package and overrides the
appName. The spark object referenced here is defined in the SparkWrapper.</p>
<div class="highlight"><pre><span></span><span class="k">package</span><span class="w"> </span><span class="n">apps</span>

<span class="k">import</span><span class="w"> </span><span class="nn">common</span><span class="p">.</span><span class="nc">SparkWrapper</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">rdd</span><span class="p">.</span><span class="nc">RDD</span>

<span class="k">object</span><span class="w"> </span><span class="nc">SparkWordCount</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SparkWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">appName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Spark Word Count&quot;</span><span class="w"></span>

<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">CliArgs</span><span class="p">(</span><span class="n">textToCount</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">parseCli</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">CliArgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">scopt</span><span class="p">.</span><span class="nc">OptionParser</span><span class="p">[</span><span class="nc">CliArgs</span><span class="p">](</span><span class="s">&quot;SparkWordCountApp&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">head</span><span class="p">(</span><span class="s">&quot;Spark word count app&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">opt</span><span class="p">[</span><span class="nc">String</span><span class="p">](</span><span class="s">&quot;textToCount&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">required</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s">&quot;The text to count words with&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">action</span><span class="p">((</span><span class="n">param</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">textToCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">parser</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="nc">CliArgs</span><span class="p">()).</span><span class="n">getOrElse</span><span class="p">({</span><span class="w"></span>
<span class="w">      </span><span class="n">parser</span><span class="p">.</span><span class="n">showUsage</span><span class="w"></span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Exception</span><span class="p">(</span><span class="s">&quot;could not parse command&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Calculates the count of unique words in a collection of strings</span>
<span class="cm">   * @param text a sequence of individual strings to count words from</span>
<span class="cm">   * @return an RDD of word to count tuples</span>
<span class="cm">   */</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">countWords</span><span class="p">(</span><span class="n">text</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">RDD</span><span class="p">[(</span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="nc">Int</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">sparkContext</span><span class="p">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">lines</span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="n">line</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)).</span><span class="n">map</span><span class="p">(</span><span class="n">word</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="n">_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cliArgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseCli</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">textToCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cliArgs</span><span class="p">.</span><span class="n">textToCount</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">).</span><span class="n">toSeq</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">countWords</span><span class="p">(</span><span class="n">textToCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">counts</span><span class="p">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">println</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="add-unit-tests">
<h2>Add Unit Tests</h2>
<p>To run unit tests on our Spark applications we can use the ScalaTest library. We'll just create corresponding files
in the test directory with the same name as the classes/objects defined in the main directory but suffixed with the word &quot;Test.&quot;
Below is a sample unit test for the countWords method in the SparkWordCount object defined above.</p>
<div class="highlight"><pre><span></span><span class="k">package</span><span class="w"> </span><span class="n">apps</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">scalatest</span><span class="p">.</span><span class="nn">funsuite</span><span class="p">.</span><span class="nc">AnyFunSuite</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="nc">SparkSession</span>

<span class="k">import</span><span class="w"> </span><span class="nn">testutils</span><span class="p">.</span><span class="nc">SparkTestWrapper</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SparkWordCountTest</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">AnyFunSuite</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">spark</span><span class="p">:</span><span class="w"> </span><span class="nc">SparkSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SparkTestWrapper</span><span class="p">.</span><span class="n">spark</span><span class="w"></span>

<span class="w">  </span><span class="n">test</span><span class="p">(</span><span class="s">&quot;testing that countWords can correctly generate a count of words from a block of text&quot;</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wordsToCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="s">&quot;some words to count&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;some other words to count&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">countsOne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SparkWordCount</span><span class="p">.</span><span class="n">countWords</span><span class="p">(</span><span class="n">wordsToCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">expectedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Set</span><span class="p">((</span><span class="s">&quot;some&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;words&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;count&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;other&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;to&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">countsOne</span><span class="p">.</span><span class="n">collect</span><span class="p">().</span><span class="n">toSet</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expectedCount</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
<p>The final tree from the root project directory looks like this.</p>
<img alt="Step 5 in creating a Spark Hello World project" src="/static/post15/post15_step5.png" style="width: 100%;" />
</div>
<div class="section" id="build-it">
<h2>Build It</h2>
<p>To build our project we can simply run the SBT assembly process with the following command.</p>
<div class="highlight"><pre><span></span>&gt; sbt assembly
</pre></div>
<p>This should download the required dependencies, compile your code, and package all the necessary files into a fat or uber
jar that can be executed on your cluster of choice. This should also run your tests, which you will see in the terminal
as shown below.</p>
<img alt="Step 6 in creating a Spark Hello World project" src="/static/post15/post15_step6.png" style="width: 100%;" />
</div>
<div class="section" id="run-it">
<h2>Run It!</h2>
<p>To run your application you first need to find the uber jar created by sbt assembly. After running sbt assembly, you will
notice that a target directory was created in your root project directory. Travel there and into the scala-2.x subdirectory.</p>
<div class="highlight"><pre><span></span>&gt; <span class="nb">cd</span> target/scala-*
</pre></div>
<p>Here you will find an assembly jar as shown in the screenshot below.</p>
<img alt="Step 7 in creating a Spark Hello World project" src="/static/post15/post15_step7.png" style="width: 100%;" />
<p>You can then deploy this jar to wherever your cluster needs it to be. For example, if you're using EMR, you can deploy to
some S3 bucket. Then your spark-submit command can be something like the following. Notice the S3 path, which points to
the bucket I deployed my jar to.</p>
<div class="highlight"><pre><span></span>spark-submit --deploy-mode cluster --executor-memory 1g --class apps.SparkWordCount
s3://sparkjarsar/sparkflow-sparkapps-assembly-1.0.jar --textToCount <span class="s2">&quot;some words to count&quot;</span>
</pre></div>
<p>An example of all of this can be found in my <a class="reference external" href="https://github.com/adaros92/sparkflow-sparkapps">Github</a>. Happy coding!</p>
</div>


		<div id="article_meta">
				Category:
					<a href="https://decipheringbigdata.com/category/data-engineering.html">Data Engineering</a>
				<br />Tags:
					<a href="https://decipheringbigdata.com/tag/data-engineering.html">Data Engineering</a>
		</div>
	</article>

	<footer>
		<a href="https://decipheringbigdata.com/" class="button_accent">&larr;&nbsp;&nbsp;&nbsp;Back to blog</a>
	</footer>


	</section>

</body>
</html>