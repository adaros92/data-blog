<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Adams Rosales' personal blog on everything data, software, and working in the tech industry">
        <meta name="keywords" content="Data,Machine Learning,Data Science,Engineering,AI,Analytics,Big Data,Software">
        <meta name="author" content="Adams Rosales">

        <title>Deciphering Big Data</title>

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-DZPNKZL3NS"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-DZPNKZL3NS');
        </script>


        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/darkly.css" rel="stylesheet">

        <link rel="apple-touch-icon" sizes="180x180" href="extra/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="extra/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="extra/favicon/favicon-16x16.png">
        <link rel="icon" sizes="16x16 24x24 32x32 48x48 64x64" href="extra/favicon/favicon.ico">
        <link rel="manifest" href="extra/favicon/site.webmanifest">

        <!-- Custom Fonts -->
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
        




        <meta name="tags" contents="Data Engineering" />


			<meta property="og:locale" content="en">
		<meta property="og:site_name" content="Deciphering Big Data">

	<meta property="og:type" content="article">
	<meta property="article:author" content="">
	<meta property="og:url" content="/redshift-optimization.html">
	<meta property="og:title" content="Redshift Optimization">
	<meta property="og:description" content="">
	<meta property="og:image" content="//static/post14/header.jpg">
	<meta property="article:published_time" content="2021-03-26 00:00:00-07:00">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Deciphering Big Data</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/static/post14/header.jpg');opacity: 0.9">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Redshift Optimization</h1>
                        <span class="meta">Posted by
                                <a href="https://www.linkedin.com/in/adamsr09/">Adams Rosales</a>
                             on Fri 26 March 2021
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <div class="section" id="an-overview-of-redshift">
<h2>An Overview of Redshift</h2>
<p><a class="reference external" href="https://aws.amazon.com/redshift/">Redshift</a> is a fully managed cloud data warehouse available on AWS. It's the most
popular data warehousing solution in use today due to its efficient columnar data storage, distributed parallel
processing capabilities, and seamless scalability. It also integrates quite well with other AWS services like S3, Athena,
and Glue, making it easier to move data in and out of the warehouse in addition to simply using Redshift as a compute
engine on data physically stored in S3 without having to move the data out of S3.</p>
<p>A Redshift cluster includes a single driver node and a collection of worker nodes. How many worker nodes exactly depends
on the node types used (dc2, ds2, ra3) and how the cluster was configured when launched. Typically the number of worker
nodes ranges from 1-128. These worker nodes are further divided into slices, which represent compute and storage units
using equally sized portions of each node's memory and disk space. The number of slices per node also depends on the
types of nodes being used, ranging from 2 to 32 slices per node.</p>
<img alt="A diagram of the Redshift architecture" src="/static/post14/post14_redshift_diagram.jpeg" style="width: 100%;" />
<p>The data are physically stored in the worker node slices and each slice is operated on in parallel to achieve
distributed data processing. How the data are distributed among the slices is one of the important considerations an
engineer must have to allow efficient access to that data. There are three different ways to do this:</p>
<ul class="simple">
<li>Even - a round-robin distribution of records. Imagine going down a list of rows and alternating slices as you go so
that the data are evenly split across all the nodes.</li>
<li>All - includes a full copy of the data in the first slice of each worker node.</li>
<li>Key - acts like a hash table by first creating a unique hash key off of a column specified by the user during table
creation and then co-locating the records with the same hashed value in the same slices. This means that all records
pertaining to a certain column's value will be in the same slice together (for example, distributing on country code
will result in all US records being stored in the same slice).</li>
</ul>
<p>While you can think of the records as being distributed a certain way according to the table's distribution style, the
actual data is organized on disk such that the individual columns are stored in separate files, which are further
broken down into 1MB blocks on disk. Because the data are stored in a column-oriented format as opposed to a row-oriented
format where individual files contain entire rows of data, fewer data need to be retrieved for analytical queries
which only need certain column from the data. It also makes it possible to compress the block files more than if they
contained entire rows of data because only the same type of data are stored together in single files depending on the
column types.</p>
<p>These column block files also benefit from an additional optimization called zone mapping. Zone maps are metadata stored
in memory that provide the min and max values of the data in each block. When any sort of filtering is applied
on the data (for example, where date between '2021-01-01' and '2021-01-31'), Redshift is able to skip files where the
values being filtered for are not within the min and max range contained in the zone maps. This reduces expensive I/O from
disk thereby improving performance substantially.</p>
<img alt="A diagram of how zone maps work in Redshift" src="/static/post14/post14_zonemaps.png" style="width: 100%;" />
<p>How effective these zone maps are at reducing the data scanned depends on how well the data are sorted on disk.
As shown in the diagram above, if the data are not sorted, files can contain wide ranges of values in the zone maps,
rendering them pretty useless at reducing the amount of files that need to be read. Thankfully, Redshift provides
the ability to physically sort the data on disk via sort keys, which are defined at table creation time along with
distribution styles. There are two types of sort keys:</p>
<ul class="simple">
<li>Compound - sorts data based on the columns in the order they're specified in. It behaves the same way as order by
column1, column2, column3, etc. It will first sort on column1, followed by column2, then column3, etc. These are used
most often and it's the default type of sort key applied by Redshift. They work well when there are clear filtering
patterns on the data, during aggregations which require grouping and/or sorting, and joins.</li>
<li>Interleaved - uses Z-order curves through N-dimensional space to give equal weights to the columns being used in the
sort key. Interleaved sort keys are not used much in practice but they do provide an advantage with very large tables and when
there is no clear filtering pattern on the data (users may filter by many different columns when querying).</li>
</ul>
<p>One important caveat to note is that when records are inserted in Redshift they will not be automatically sorted
according to the sort keys specified with the tables unless the data are copied in from S3 for the first time.
Historically tables in Redshift would become unsorted over time as new records were inserted unless someone went in
and ran a vacuum sort operation on those tables from time to time. This operation deletes any records marked for
deletion and physically sorts the data according to a table's sort key. However, in 2019 <a class="reference external" href="https://aws.amazon.com/about-aws/whats-new/2019/11/amazon-redshift-introduces-automatic-table-sort-alternative-vacuum-sort/">auto vacuum sort</a>
introduced which sorts data behind the scenes periodically so it's not much of an issue anymore. It's still good
practice to ensure that 1) tables are indeed sorted by querying <a class="reference external" href="https://docs.aws.amazon.com/redshift/latest/dg/r_SVV_TABLE_INFO.html">SVV_TABLE_INFO</a>
and 2) that there is enough disk space on the Redshift cluster to actually perform the sorting, which requires
additional temporary space for intermediate results.</p>
</div>
<div class="section" id="optimizing-query-filters">
<h2>Optimizing Query Filters</h2>
<p>You'll often hear that you should filter on the sort keys of a Redshift table. Hopefully with the overview on zone maps
above you can see why. If you filter on the sort keys and the data are actually sorted on disk, queries can be sped up
significantly just because Redshift avoids reading unnecessary data from disk.</p>
<p>Choosing the right sort keys is <em>key</em> here.</p>
</div>
<div class="section" id="optimizing-joins-and-aggregations">
<h2>Optimizing Joins and Aggregations</h2>
</div>
<div class="section" id="optimizing-spectrum-queries">
<h2>Optimizing Spectrum Queries</h2>
</div>
<div class="section" id="use-the-explain-plan">
<h2>Use the Explain Plan</h2>
</div>
<div class="section" id="additional-resources">
<h2>Additional Resources</h2>
<p><a class="reference external" href="https://www.youtube.com/watch?v=13iIj34nkQE">Best practices overview</a> -
a good overview of Redshift best practices shown during the most recent AWS re:Invent</p>
<p><a class="reference external" href="https://aws.amazon.com/blogs/big-data/amazon-redshift-engineerings-advanced-table-design-playbook-preamble-prerequisites-and-prioritization/">Advanced table design playbook</a> -
the single best resource on Redshift optimization I've read to date</p>
<p><a class="reference external" href="https://aws.amazon.com/blogs/big-data/optimizing-tables-in-amazon-redshift-using-automatic-table-optimization/">Using Automatic Table Optimization</a> -
a relatively new feature that recommends optimal distribution and sort key configurations from data on historical query
performance</p>
</div>

    </article>

    <hr>

            </div>
        </div>
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-2">
                    <!-- AddToAny BEGIN -->
                <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
                    <a class="a2a_button_facebook"></a>
                    <a class="a2a_button_twitter"></a>
                    <a class="a2a_button_email"></a>
                    <a class="a2a_button_reddit"></a>
                    <a class="a2a_button_linkedin"></a>
                    <a class="a2a_button_evernote"></a>
                    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
                </div>
                <script async src="https://static.addtoany.com/menu/page.js"></script>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <!-- AddToAny END -->
            <p class="copyright text-muted">Learn more about me at my <a href="https://www.linkedin.com/in/adamsr09/">LinkedIn</a> or <a href="https://github.com/adaros92">Github</a>.</p>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/theme/js/clean-blog.min.js"></script>

</body>

</html>